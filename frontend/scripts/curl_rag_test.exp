#!/usr/bin/expect -f

set timeout 20
set ip "91.99.232.126"
set user "root"
set password "LpXqTEPurwUu"

spawn ssh -o StrictHostKeyChecking=no $user@$ip

expect {
    "password:" {
        send "$password\r"
        exp_continue
    }
    "# " {
    }
}

# Make a request to the chat API
# We use a message that should trigger the Support MCP (contains "problem")
send "echo '--- SENDING CURL REQUEST ---'\r"
send "curl -X POST http://localhost:3000/api/support/chat \\
  -H 'Content-Type: application/json' \\
  -d '{\"message\": \"Ich habe ein Problem mit dem Login\", \"locale\": \"de\"}'\r"
expect "# "

# Check logs immediately after to see if Edge Function was called or failed
send "echo '--- CHECKING LOGS ---'\r"
send "pm2 logs 5 --lines 30 --nostream\r"
expect "# "

send "exit\r"
expect eof
