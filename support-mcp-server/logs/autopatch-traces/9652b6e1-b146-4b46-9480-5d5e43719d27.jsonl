{"timestamp":"2025-11-27T20:54:19.381Z","ticketId":"9652b6e1-b146-4b46-9480-5d5e43719d27","patternId":"config-api_endpoint-/api/knowledge/upload","instructionCount":1,"instructions":[{"type":"create-file","file":"app/api/api/knowledge/upload/route.ts","content":"import { NextRequest, NextResponse } from 'next/server';\nimport { createRouteHandlerClient, createBackgroundAnonClient, createServiceRoleClient } from '@/lib/supabase';\nimport { writeFile, mkdir } from 'fs/promises';\nimport { join } from 'path';\nimport { parsePdfBuffer } from '@/lib/pdf/parsePdf';\n\nconst UPLOAD_DIR = join(process.cwd(), 'uploads', 'knowledge');\nconst MAX_FILE_SIZE = 10 * 1024 * 1024; // 10MB\n\nfunction getBackgroundSupabaseClient() {\n  try {\n    return createServiceRoleClient();\n  } catch (error) {\n    console.warn('[Knowledge Upload] Service-Role Client nicht verfügbar, fallback auf Anon Client.', error);\n    return createBackgroundAnonClient();\n  }\n}\n\nexport async function POST(request: NextRequest) {\n  try {\n    const formData = await request.formData();\n    const file = formData.get('file') as File;\n    const sessionId = formData.get('sessionId') as string | null;\n    const botId = formData.get('botId') as string | null;\n\n    if (!file) {\n      return NextResponse.json(\n        { error: 'Keine Datei hochgeladen' },\n        { status: 400 }\n      );\n    }\n\n    const supabase = await createRouteHandlerClient();\n\n    // Get user ID (required for bot-specific sources)\n    const { data: userData } = await supabase.auth.getUser();\n    const userId = userData.user?.id;\n\n    if (!userId && !sessionId) {\n      return NextResponse.json(\n        { error: 'Authentifizierung erforderlich' },\n        { status: 401 }\n      );\n    }\n\n    // Validate file type\n    if (file.type !== 'application/pdf') {\n      return NextResponse.json(\n        { error: 'Nur PDF-Dateien sind erlaubt' },\n        { status: 400 }\n      );\n    }\n\n    // Validate file size\n    if (file.size > MAX_FILE_SIZE) {\n      return NextResponse.json(\n        { error: 'Datei zu groß (max. 10MB)' },\n        { status: 400 }\n      );\n    }\n\n    // Create knowledge source record\n    const insertData: any = {\n      name: file.name,\n      type: 'pdf',\n      file_size: file.size,\n      status: 'processing',\n    };\n\n    if (sessionId) {\n      insertData.session_id = sessionId;\n    }\n    \n    if (userId) {\n      insertData.user_id = userId;\n    }\n    if (botId && userId) {\n      insertData.bot_id = botId;\n    }\n\n    const { data: knowledgeSource, error: sourceError } = await supabase\n      .from('knowledge_sources')\n      .insert(insertData)\n      .select()\n      .single();\n\n    if (sourceError) throw sourceError;\n\n    // Save file to disk\n    const bytes = await file.arrayBuffer();\n    const buffer = Buffer.from(bytes);\n    \n    await mkdir(UPLOAD_DIR, { recursive: true });\n    const filePath = join(UPLOAD_DIR, ' + knowledgeSource.id + '.pdf');\n    await writeFile(filePath, buffer);\n\n    // Update file path\n    await supabase\n      .from('knowledge_sources')\n      .update({ file_path: filePath })\n      .eq('id', knowledgeSource.id);\n\n    // Start PDF processing in background\n    if (userId) {\n      // Process with authenticated user context\n      (async () => {\n        try {\n          const processSupabase = await createRouteHandlerClient();\n          await processPDFDirectly(knowledgeSource.id, buffer, userId, botId || undefined, processSupabase);\n        } catch (error: any) {\n          console.error('[Upload] ❌ PDF processing failed:', error);\n          const errorSupabase = await createRouteHandlerClient();\n          await errorSupabase\n            .from('knowledge_sources')\n            .update({ \n              status: 'error', \n              metadata: { error: error.message || 'Unknown error' } \n            })\n            .eq('id', knowledgeSource.id);\n        }\n      })();\n    } else {\n      // Fallback for demo sessions\n      processPDF(knowledgeSource.id, buffer, undefined, botId || undefined).catch(async (error) => {\n        console.error('PDF processing error:', error);\n        const errorSupabase = getBackgroundSupabaseClient();\n        await errorSupabase\n          .from('knowledge_sources')\n          .update({ \n            status: 'error', \n            metadata: { error: error?.message || 'Unknown error' } \n          })\n          .eq('id', knowledgeSource.id);\n      });\n    }\n\n    return NextResponse.json({\n      id: knowledgeSource.id,\n      name: knowledgeSource.name,\n      status: 'processing',\n    });\n  } catch (error: any) {\n    console.error('Upload error:', error);\n    return NextResponse.json(\n      { error: error.message || 'Upload fehlgeschlagen' },\n      { status: 500 }\n    );\n  }\n}\n\nasync function processPDFDirectly(\n  sourceId: string,\n  buffer: Buffer,\n  userId: string,\n  botId: string | undefined,\n  supabase: any\n) {\n  const { text, pageCount } = await parsePdfBuffer(buffer);\n\n  if (!text || text.trim().length === 0) {\n    throw new Error('PDF enthält keinen Text oder kann nicht gelesen werden');\n  }\n\n  // Chunk text\n  const chunks = chunkText(text, 800, 100);\n\n  // Create chunk records\n  const chunkRecords = chunks.map((chunk, index) => {\n    const record: any = {\n      knowledge_source_id: sourceId,\n      chunk_index: index,\n      content: chunk,\n      user_id: userId,\n      metadata: {\n        page: pageCount > 0 ? Math.floor((index * 800) / (text.length / pageCount)) : 0,\n      },\n    };\n    if (botId) {\n      record.bot_id = botId;\n    }\n    return record;\n  });\n\n  // Insert chunks in batches\n  const BATCH_SIZE = 50;\n  for (let i = 0; i < chunkRecords.length; i += BATCH_SIZE) {\n    const batch = chunkRecords.slice(i, i + BATCH_SIZE);\n    const { error } = await supabase\n      .from('document_chunks')\n      .insert(batch);\n\n    if (error) {\n      throw new Error('Chunk insert failed: ' + error.message);\n    }\n  }\n\n  // Update status to ready\n  await supabase\n    .from('knowledge_sources')\n    .update({\n      status: 'ready',\n      metadata: {\n        pageCount,\n        textLength: text.length,\n        chunkCount: chunks.length,\n        processedAt: new Date().toISOString(),\n      },\n    })\n    .eq('id', sourceId);\n}\n\nasync function processPDF(sourceId: string, buffer: Buffer, userId?: string, botId?: string) {\n  const supabase = getBackgroundSupabaseClient();\n  const { text, pageCount } = await parsePdfBuffer(buffer);\n\n  if (!text || text.trim().length === 0) {\n    throw new Error('PDF enthält keinen Text oder kann nicht gelesen werden');\n  }\n\n  const chunks = chunkText(text, 800, 100);\n  const chunkRecords = chunks.map((chunk: string, index: number) => {\n    const record: any = {\n      knowledge_source_id: sourceId,\n      chunk_index: index,\n      content: chunk,\n      metadata: {\n        page: pageCount > 0 ? Math.floor((index * 800) / (text.length / pageCount)) : 0,\n      },\n    };\n    if (userId) record.user_id = userId;\n    if (botId) record.bot_id = botId;\n    return record;\n  });\n\n  const BATCH_SIZE = 50;\n  for (let i = 0; i < chunkRecords.length; i += BATCH_SIZE) {\n    const batch = chunkRecords.slice(i, i + BATCH_SIZE);\n    const { error } = await supabase\n      .from('document_chunks')\n      .insert(batch);\n\n    if (error) {\n      throw new Error('Chunk insert failed: ' + error.message);\n    }\n  }\n\n  await supabase\n    .from('knowledge_sources')\n    .update({\n      status: 'ready',\n      metadata: {\n        pageCount,\n        textLength: text.length,\n        chunkCount: chunks.length,\n        processedAt: new Date().toISOString(),\n      },\n    })\n    .eq('id', sourceId);\n}\n\nfunction chunkText(text: string, chunkSize: number, overlap: number): string[] {\n  const chunks: string[] = [];\n  let start = 0;\n  \n  while (start < text.length) {\n    const end = Math.min(start + chunkSize, text.length);\n    const chunk = text.slice(start, end);\n    if (chunk.length > 0) {\n      chunks.push(chunk);\n    }\n    start = end - overlap;\n    if (start >= text.length) break;\n  }\n  \n  return chunks.length > 0 ? chunks : [text];\n}\n","description":"Erstelle fehlende API-Route /api/knowledge/upload basierend auf Reverse Engineering Dokumentation"}]}
{"timestamp":"2025-11-27T21:15:16.860Z","ticketId":"9652b6e1-b146-4b46-9480-5d5e43719d27","patternId":"config-api_endpoint-/api/knowledge/upload/route","instructionCount":1,"instructions":[{"type":"create-file","file":"app/api/api/knowledge/upload/route/route.ts","content":"import { NextRequest, NextResponse } from 'next/server';\nimport { createRouteHandlerClient } from '@/lib/supabase';\n\n/**\n * - `app/api/knowledge/url/route.ts` - Bot ID Support\n * Auto-generiert basierend auf Reverse Engineering Dokumentation\n */\n\nexport async function POST(\n  request: NextRequest,\n  { params }: { params: { id: string } }\n) {\n  try {\n    const supabase = await createRouteHandlerClient();\n    const { data: userData } = await supabase.auth.getUser();\n    const userId = userData.user?.id;\n    \n    if (!userId) {\n      return NextResponse.json(\n        { error: 'Authentifizierung erforderlich' },\n        { status: 401 }\n      );\n    }\n    \n    const botId = params.id;\n    \n    // Verify bot ownership\n    const { data: bot, error: botError } = await supabase\n      .from('bots')\n      .select('*')\n      .eq('id', botId)\n      .eq('user_id', userId)\n      .single();\n    \n    if (botError || !bot) {\n      return NextResponse.json(\n        { error: 'Bot nicht gefunden oder nicht autorisiert' },\n        { status: 404 }\n      );\n    }\n    \n    // TODO: Implementiere spezifische Bot-Logik\n    // - `app/api/knowledge/url/route.ts` - Bot ID Support\n    \n    return NextResponse.json({\n      success: true,\n      botId,\n    });\n  } catch (error: any) {\n    console.error('[Bot] Error:', error);\n    return NextResponse.json(\n      { error: error.message || 'Bot operation failed' },\n      { status: 500 }\n    );\n  }\n}\n","description":"Erstelle fehlende API-Route /api/knowledge/upload/route basierend auf Reverse Engineering Dokumentation"}]}
{"timestamp":"2025-11-28T08:15:52.861Z","ticketId":"9652b6e1-b146-4b46-9480-5d5e43719d27","patternId":"config-frontend_config-lib/pdf/parsePdf.ts","instructionCount":1,"instructions":[{"type":"code-modify","file":"lib/pdf/parsePdf.ts","modifications":[{"action":"remove","search":"(?:import|require|from).*pdf\\.worker[^'\"]*","description":"Entferne explizite Worker-Pfad-Referenzen (universell für alle PDF-Probleme)"},{"action":"remove","search":"(?:import|require|from).*worker\\.mjs[^'\"]*","description":"Entferne explizite Worker-MJS-Referenzen (universell für alle PDF-Probleme)"},{"action":"remove","search":"(?:import|require|from).*worker\\.js[^'\"]*","description":"Entferne explizite Worker-JS-Referenzen (universell für alle PDF-Probleme)"}]}]}
{"timestamp":"2025-11-28T10:00:56.557Z","ticketId":"9652b6e1-b146-4b46-9480-5d5e43719d27","patternId":"config-frontend_config-lib/pdf/parsePdf.ts","instructionCount":1,"instructions":[{"type":"code-modify","file":"lib/pdf/parsePdf.ts","modifications":[{"action":"remove","search":"(?:import|require|from).*pdf\\.worker[^'\"]*","description":"Entferne explizite Worker-Pfad-Referenzen (universell für alle PDF-Probleme)"},{"action":"remove","search":"(?:import|require|from).*worker\\.mjs[^'\"]*","description":"Entferne explizite Worker-MJS-Referenzen (universell für alle PDF-Probleme)"},{"action":"remove","search":"(?:import|require|from).*worker\\.js[^'\"]*","description":"Entferne explizite Worker-JS-Referenzen (universell für alle PDF-Probleme)"}]}]}
{"timestamp":"2025-11-28T10:03:18.621Z","ticketId":"9652b6e1-b146-4b46-9480-5d5e43719d27","patternId":"config-frontend_config-lib/pdf/parsePdf.ts","instructionCount":1,"instructions":[{"type":"code-modify","file":"lib/pdf/parsePdf.ts","modifications":[{"action":"remove","search":"(?:import|require|from).*pdf\\.worker[^'\"]*","description":"Entferne explizite Worker-Pfad-Referenzen (universell für alle PDF-Probleme)"},{"action":"remove","search":"(?:import|require|from).*worker\\.mjs[^'\"]*","description":"Entferne explizite Worker-MJS-Referenzen (universell für alle PDF-Probleme)"},{"action":"remove","search":"(?:import|require|from).*worker\\.js[^'\"]*","description":"Entferne explizite Worker-JS-Referenzen (universell für alle PDF-Probleme)"}]}]}
{"timestamp":"2025-11-28T10:06:49.485Z","ticketId":"9652b6e1-b146-4b46-9480-5d5e43719d27","patternId":"config-frontend_config-lib/pdf/parsePdf.ts","instructionCount":1,"instructions":[{"type":"code-modify","file":"lib/pdf/parsePdf.ts","modifications":[{"action":"remove","search":"(?:import|require|from).*pdf\\.worker[^'\"]*","description":"Entferne explizite Worker-Pfad-Referenzen (universell für alle PDF-Probleme)"},{"action":"remove","search":"(?:import|require|from).*worker\\.mjs[^'\"]*","description":"Entferne explizite Worker-MJS-Referenzen (universell für alle PDF-Probleme)"},{"action":"remove","search":"(?:import|require|from).*worker\\.js[^'\"]*","description":"Entferne explizite Worker-JS-Referenzen (universell für alle PDF-Probleme)"}]}]}
{"timestamp":"2025-11-28T10:10:33.938Z","ticketId":"9652b6e1-b146-4b46-9480-5d5e43719d27","patternId":"config-frontend_config-lib/pdf/parsePdf.ts","instructionCount":1,"instructions":[{"type":"code-modify","file":"lib/pdf/parsePdf.ts","modifications":[{"action":"remove","search":"(?:import|require|from).*pdf\\.worker[^'\"]*","description":"Entferne explizite Worker-Pfad-Referenzen (universell für alle PDF-Probleme)"},{"action":"remove","search":"(?:import|require|from).*worker\\.mjs[^'\"]*","description":"Entferne explizite Worker-MJS-Referenzen (universell für alle PDF-Probleme)"},{"action":"remove","search":"(?:import|require|from).*worker\\.js[^'\"]*","description":"Entferne explizite Worker-JS-Referenzen (universell für alle PDF-Probleme)"}]}]}
{"timestamp":"2025-11-28T10:13:21.697Z","ticketId":"9652b6e1-b146-4b46-9480-5d5e43719d27","patternId":"config-frontend_config-lib/pdf/parsePdf.ts","instructionCount":1,"instructions":[{"type":"code-modify","file":"lib/pdf/parsePdf.ts","modifications":[{"action":"remove","search":"(?:import|require|from).*pdf\\.worker[^'\"]*","description":"Entferne explizite Worker-Pfad-Referenzen (universell für alle PDF-Probleme)"},{"action":"remove","search":"(?:import|require|from).*worker\\.mjs[^'\"]*","description":"Entferne explizite Worker-MJS-Referenzen (universell für alle PDF-Probleme)"},{"action":"remove","search":"(?:import|require|from).*worker\\.js[^'\"]*","description":"Entferne explizite Worker-JS-Referenzen (universell für alle PDF-Probleme)"}]}]}
{"timestamp":"2025-11-28T10:13:53.215Z","ticketId":"9652b6e1-b146-4b46-9480-5d5e43719d27","patternId":"config-frontend_config-lib/pdf/parsePdf.ts","instructionCount":1,"instructions":[{"type":"code-modify","file":"lib/pdf/parsePdf.ts","modifications":[{"action":"remove","search":"(?:import|require|from).*pdf\\.worker[^'\"]*","description":"Entferne explizite Worker-Pfad-Referenzen (universell für alle PDF-Probleme)"},{"action":"remove","search":"(?:import|require|from).*worker\\.mjs[^'\"]*","description":"Entferne explizite Worker-MJS-Referenzen (universell für alle PDF-Probleme)"},{"action":"remove","search":"(?:import|require|from).*worker\\.js[^'\"]*","description":"Entferne explizite Worker-JS-Referenzen (universell für alle PDF-Probleme)"}]}]}
{"timestamp":"2025-11-28T10:14:25.928Z","ticketId":"9652b6e1-b146-4b46-9480-5d5e43719d27","patternId":"config-frontend_config-lib/pdf/parsePdf.ts","instructionCount":1,"instructions":[{"type":"code-modify","file":"lib/pdf/parsePdf.ts","modifications":[{"action":"remove","search":"(?:import|require|from).*pdf\\.worker[^'\"]*","description":"Entferne explizite Worker-Pfad-Referenzen (universell für alle PDF-Probleme)"},{"action":"remove","search":"(?:import|require|from).*worker\\.mjs[^'\"]*","description":"Entferne explizite Worker-MJS-Referenzen (universell für alle PDF-Probleme)"},{"action":"remove","search":"(?:import|require|from).*worker\\.js[^'\"]*","description":"Entferne explizite Worker-JS-Referenzen (universell für alle PDF-Probleme)"}]}]}
{"timestamp":"2025-11-28T10:20:02.612Z","ticketId":"9652b6e1-b146-4b46-9480-5d5e43719d27","patternId":"config-frontend_config-lib/pdf/parsePdf.ts","instructionCount":1,"instructions":[{"type":"code-modify","file":"lib/pdf/parsePdf.ts","modifications":[{"action":"remove","search":"(?:import|require|from).*pdf\\.worker[^'\"]*","description":"Entferne explizite Worker-Pfad-Referenzen (universell für alle PDF-Probleme)"},{"action":"remove","search":"(?:import|require|from).*worker\\.mjs[^'\"]*","description":"Entferne explizite Worker-MJS-Referenzen (universell für alle PDF-Probleme)"},{"action":"remove","search":"(?:import|require|from).*worker\\.js[^'\"]*","description":"Entferne explizite Worker-JS-Referenzen (universell für alle PDF-Probleme)"}]}]}
{"timestamp":"2025-11-28T10:20:07.927Z","ticketId":"9652b6e1-b146-4b46-9480-5d5e43719d27","patternId":"config-frontend_config-lib/pdf/parsePdf.ts","instructionCount":1,"instructions":[{"type":"code-modify","file":"lib/pdf/parsePdf.ts","modifications":[{"action":"remove","search":"(?:import|require|from).*pdf\\.worker[^'\"]*","description":"Entferne explizite Worker-Pfad-Referenzen (universell für alle PDF-Probleme)"},{"action":"remove","search":"(?:import|require|from).*worker\\.mjs[^'\"]*","description":"Entferne explizite Worker-MJS-Referenzen (universell für alle PDF-Probleme)"},{"action":"remove","search":"(?:import|require|from).*worker\\.js[^'\"]*","description":"Entferne explizite Worker-JS-Referenzen (universell für alle PDF-Probleme)"}]}]}
{"timestamp":"2025-11-28T10:25:36.240Z","ticketId":"9652b6e1-b146-4b46-9480-5d5e43719d27","patternId":"config-frontend_config-lib/pdf/parsePdf.ts","instructionCount":1,"instructions":[{"type":"code-modify","file":"lib/pdf/parsePdf.ts","modifications":[{"action":"remove","search":"(?:import|require|from).*pdf\\.worker[^'\"]*","description":"Entferne explizite Worker-Pfad-Referenzen (universell für alle PDF-Probleme)"},{"action":"remove","search":"(?:import|require|from).*worker\\.mjs[^'\"]*","description":"Entferne explizite Worker-MJS-Referenzen (universell für alle PDF-Probleme)"},{"action":"remove","search":"(?:import|require|from).*worker\\.js[^'\"]*","description":"Entferne explizite Worker-JS-Referenzen (universell für alle PDF-Probleme)"}]}]}
{"timestamp":"2025-11-28T10:27:16.668Z","ticketId":"9652b6e1-b146-4b46-9480-5d5e43719d27","patternId":"config-frontend_config-lib/pdf/parsePdf.ts","instructionCount":1,"instructions":[{"type":"code-modify","file":"lib/pdf/parsePdf.ts","modifications":[{"action":"remove","search":"(?:import|require|from).*pdf\\.worker[^'\"]*","description":"Entferne explizite Worker-Pfad-Referenzen (universell für alle PDF-Probleme)"},{"action":"remove","search":"(?:import|require|from).*worker\\.mjs[^'\"]*","description":"Entferne explizite Worker-MJS-Referenzen (universell für alle PDF-Probleme)"},{"action":"remove","search":"(?:import|require|from).*worker\\.js[^'\"]*","description":"Entferne explizite Worker-JS-Referenzen (universell für alle PDF-Probleme)"}]}]}
{"timestamp":"2025-11-28T13:51:02.406Z","ticketId":"9652b6e1-b146-4b46-9480-5d5e43719d27","patternId":"config-frontend_config-lib/pdf/parsePdf.ts","instructionCount":1,"instructions":[{"type":"code-modify","file":"lib/pdf/parsePdf.ts","modifications":[{"action":"remove","search":"(?:import|require|from).*pdf\\.worker[^'\"]*","description":"Entferne explizite Worker-Pfad-Referenzen (universell für alle PDF-Probleme)"},{"action":"remove","search":"(?:import|require|from).*worker\\.mjs[^'\"]*","description":"Entferne explizite Worker-MJS-Referenzen (universell für alle PDF-Probleme)"},{"action":"remove","search":"(?:import|require|from).*worker\\.js[^'\"]*","description":"Entferne explizite Worker-JS-Referenzen (universell für alle PDF-Probleme)"}]}]}
